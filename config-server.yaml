apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-server
  namespace: next-me
  labels:
    app: config-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: config-server
  template:
    metadata:
      labels:
        app: config-server
    spec:
      # GHCR Private 접근 시 필요 (이미 만들어 둔 Secret)
      imagePullSecrets:
        - name: ghcr-cred

      containers:
        - name: config-server

          # 초기값(실제 배포 시 Jenkins가 set image로 SHA태그로 바꿈)
          image: ghcr.io/sparta-next-me/config-server:latest

          # SHA 태그(불변) 배포라면 IfNotPresent여도 충분하지만,
          # 환경 이슈 줄이려면 Always도 무난합니다.
          imagePullPolicy: Always

          ports:
            - containerPort: 3100

          # Spring 프로파일 (필요에 맞게 조정)
          # 예: config-server는 git 백엔드이므로 git + prod 같이 사용
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"

          # 리소스 제한
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"

          # 준비 상태 체크: 트래픽 받을 준비가 됐는지
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 3100
            initialDelaySeconds: 20
            periodSeconds: 10

          # 생존 체크: 프로세스가 죽었으면 재시작
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 3100
            initialDelaySeconds: 60
            periodSeconds: 20

---
apiVersion: v1
kind: Service
metadata:
  name: config-server
  namespace: next-me
spec:
  selector:
    app: config-server

  # 기본은 내부 통신용 ClusterIP 권장
  type: ClusterIP

  ports:
    - name: http
      port: 3100
      targetPort: 3100
