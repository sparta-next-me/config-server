apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-server
  namespace: next-me
  labels:
    app: config-server
spec:
  # [수정] 고가용성을 위해 2대로 증설
  replicas: 2
  # [추가] 무중단 배포 전략
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: config-server
  template:
    metadata:
      labels:
        app: config-server
    spec:
      # [추가] 유레카처럼 두 노드(app, infra)에 찢어서 배포
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - config-server
              topologyKey: "kubernetes.io/hostname"
      imagePullSecrets:
        - name: ghcr-cred
      containers:
        - name: config-server
          image: ghcr.io/sparta-next-me/config-server:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 3100 # 도커에서 쓰던 포트 그대로 유지
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
            # [추가 권장] 유레카 주소를 환경변수로 명시해두면 더 확실합니다
            - name: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
              value: "http://eureka-server.next-me.svc.cluster.local:3151/eureka/"
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          # [수정] 컨피그 서버는 Git을 땡겨와야 해서 시간을 좀 더 넉넉히 줍니다
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 3100
            initialDelaySeconds: 40 # 20초는 너무 빠를 수 있어 40초로 변경
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 3100
            initialDelaySeconds: 80 # 부팅 완료 후 체크 시작
            periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: config-server
  namespace: next-me
spec:
  selector:
    app: config-server
  type: ClusterIP # 내부 통신 전용
  ports:
    - name: http
      port: 3100       # 다른 서비스들이 찾아올 포트
      targetPort: 3100 # 실제 컨테이너 포트